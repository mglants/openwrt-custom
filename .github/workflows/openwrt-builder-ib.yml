name: OpenWrt Firmware (ImageBuilder)

on:
  workflow_dispatch:
    inputs:
      select:
        description: "Select device to build"
        required: false
        default: ""
        type: string
  push:
    paths:
      - "devices/**"
      - ".github/workflows/openwrt-builder-ib.yml"

env:
  TZ: Europe/Moscow

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find devices
        id: discover
        uses: mirceanton/action-folder-matrix@510538fe18f90e23766215b5f856a516ec5739bc
        with:
          path: ./devices
          changed-only: ${{ github.event_name != 'workflow_dispatch' }}
          filter: ${{ inputs.select }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  build:
    runs-on: arc-runner-set-openwrt-custom
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover-containers.outputs.directory) }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Stop if device not changed
        if: steps.changes.outputs.device != 'true'
        run: |
          echo "No changes for ${{ matrix.device }}, skipping build."
          exit 0

      - name: Install helpers
        if: steps.changes.outputs.device == 'true'
        run: |
          set -euo pipefail
          sudo apt-get -qq update
          sudo apt-get -qq install -y --no-install-recommends \
          curl ca-certificates wget tar xz-utils gzip gettext-base \
          build-essential file libncurses-dev zlib1g-dev gawk git \
          gettext libssl-dev xsltproc rsync wget unzip python3 python3-distutils
      - name: Load device env + set download base
        if: steps.changes.outputs.device == 'true'
        run: |
          set -euo pipefail
          source devices/${{ matrix.device }}/env.sh

          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "PROFILE=$PROFILE" >> $GITHUB_ENV
          echo "OPKG_ARCH=$OPKG_ARCH" >> $GITHUB_ENV

          if [ "${OPENWRT_CHANNEL:-release}" = "snapshot" ]; then
            echo "OPENWRT_VERSION=SNAPSHOT" >> $GITHUB_ENV
            echo "DL_BASE=https://downloads.openwrt.org/snapshots" >> $GITHUB_ENV
          else
            V="${OPENWRT_VERSION#v}"
            MAJOR="$(echo "$V" | grep -oE '^[0-9]+\.[0-9]+')"
            echo "OPENWRT_VERSION=$V" >> $GITHUB_ENV
            echo "OPENWRT_VERSION_MAJOR=$MAJOR" >> "$GITHUB_ENV"
            echo "DL_BASE=https://downloads.openwrt.org/releases/$V" >> $GITHUB_ENV
          fi

      - name: Generate release tag
        if: steps.changes.outputs.device == 'true'
        id: tag
        run: |
          release_date="$(date +"%Y.%m.%d-%H%M")"
          echo "release_tag=${{ matrix.device }}-${{ env.OPENWRT_VERSION }}-$release_date" >> $GITHUB_OUTPUT
          touch release.txt
          [ ${UPLOAD_GOFILE} = true && ${{ steps.gofile.outputs.url }} ] && echo "ðŸ”— [GoFile](${{ steps.gofile.outputs.url }})" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Read packages.txt
        if: steps.changes.outputs.device == 'true'
        run: |
          set -euo pipefail
          PACKAGES="$(grep -hvE '^\s*$|^\s*#' devices/${{ matrix.device }}/packages.txt \
            | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g')"
          echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

      - name: Download ImageBuilder
        if: steps.changes.outputs.device == 'true'
        run: |
          set -euo pipefail

          # zstd is required for .tar.zst
          sudo apt-get -qq update
          sudo apt-get -qq install -y --no-install-recommends wget tar zstd ca-certificates

          IB_URL="${DL_BASE}/targets/${TARGET}/${SUBTARGET}/openwrt-imagebuilder-${OPENWRT_VERSION}-${TARGET}-${SUBTARGET}.Linux-x86_64.tar.zst"
          echo "IB_URL=$IB_URL"

          wget -q "$IB_URL" -O imagebuilder.tar.zst

          # Extract .tar.zst
          tar --zstd -xf imagebuilder.tar.zst

          # Normalize directory name
          mv openwrt-imagebuilder-* imagebuilder
          ls ./
          ls imagebuilder/

      - name: Prepare FILES overlay (feeds.tpl + keys.conf + device files)
        if: steps.changes.outputs.device == 'true'
        run: |
          set -euo pipefail
          # Expand feeds template from device dir
          FEEDS_TPL="devices/${{ matrix.device }}/feeds.conf.tpl"
          if [ ! -f "$FEEDS_TPL" ]; then
            echo "Missing $FEEDS_TPL" >&2
            exit 1
          fi

          # Expand only these vars
          export OPENWRT_VERSION="${{ env.OPENWRT_VERSION }}"
          export OPENWRT_VERSION_MAJOR="${{ env.OPENWRT_VERSION_MAJOR }}"
          export OPKG_ARCH="${{ env.OPKG_ARCH }}"
          export SUBTARGET="${{ env.SUBTARGET }}"
          envsubst '${OPENWRT_VERSION} ${OPENWRT_VERSION_MAJOR} ${OPKG_ARCH} ${SUBTARGET}' < "$FEEDS_TPL" > imagebuilder/customfeeds.conf

          echo "=== customfeeds.conf ==="
          cat imagebuilder/customfeeds.conf
          sed -i '1r imagebuilder/customfeeds.conf' imagebuilder/repositories.conf
          sed -i '/option check_signature/d' imagebuilder/repositories.conf
          # Download keys listed in keys.conf (KEYID URL)
          KEYCONF="devices/${{ matrix.device }}/keys.conf"
          if [ -f "$KEYCONF" ]; then
            while read -r keyid url; do
              [ -z "${keyid:-}" ] && continue
              case "$keyid" in \#*) continue ;; esac
              echo "Key $keyid <- $url"
              curl -fsSL "$url" -o "imagebuilder/keys/$keyid"
              test -s "imagebuilder/keys/$keyid"
            done < "$KEYCONF"
          else
            echo "No keys.conf for ${{ matrix.device }} (skipping key download)"
          fi

          # Copy device overlay files (optional)
          if [ -d "devices/${{ matrix.device }}/files" ]; then
            cp -a "devices/${{ matrix.device }}/files/." "imagebuilder/files/"
          fi

      - name: Download custom IPKs (optional)
        if: steps.changes.outputs.device == 'true'
        run: |
          set -euo pipefail
          IPK_LIST="devices/${{ matrix.device }}/ipk-urls.txt"
          envsubst < devices/${{ matrix.device }}/ipk-urls.txt.tpl > $IPK_LIST
          if [ -f "$IPK_LIST" ]; then
            while read -r url; do
              [ -z "${url:-}" ] && continue
              case "$url" in \#*) continue ;; esac
              echo "Downloading IPK: $url"
              curl -fL --retry 3 --retry-delay 2 \
                -o "imagebuilder/packages/$(basename "$url")" "$url"
            done < "$IPK_LIST"

          else
            echo "No ipk-urls.txt for ${{ matrix.device }} (skipping custom IPKs)"
          fi

      - name: Build firmware
        if: steps.changes.outputs.device == 'true'
        run: |
          set -euo pipefail
          cd imagebuilder
          make image PROFILE="${PROFILE}" PACKAGES="${PACKAGES}" FILES="files"

      - name: Collect firmware
        if: steps.changes.outputs.device == 'true'
        run: |
          set -euo pipefail
          mkdir -p output/${{ matrix.device }}
          cp -a imagebuilder/bin/targets/*/* output/${{ matrix.device }}/
          rm -rf output/${{ matrix.device }}/packages || true

      - name: Upload firmware artifact
        if: steps.changes.outputs.device == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ steps.tag.outputs.release_tag }}
          path: output/${{ matrix.device }}

      - name: Upload firmware to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        if: steps.tag.outputs.status == 'success' && !cancelled() && steps.changes.outputs.device == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: output/${{ matrix.device }}/*/*

      - name: Delete workflow runs
        if: steps.changes.outputs.device == 'true'
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 5

      - name: Remove old Releases
        if: steps.changes.outputs.device == 'true' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        uses: dev-drprasad/delete-older-releases@master
        with:
          keep_latest: 5
          delete_tags: true
          delete_tag_pattern: ${{ matrix.device }}-${{ env.OPENWRT_VERSION }}.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
