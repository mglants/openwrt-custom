name: OpenWrt Firmware (ImageBuilder)

on:
  workflow_dispatch:
  # push:
  #   paths:
  #     - "devices/**"
  #     - ".github/workflows/firmware-imagebuilder.yml"

env:
  TZ: Europe/Moscow

jobs:
  build:
    runs-on: arc-runner-set-openwrt-custom
    strategy:
      fail-fast: false
      matrix:
        device:
          - ax6s
          # - ax3000t
          # - ax6000
          # - bpi3mini
          # - bpi4
          # - netisn6
          # - rb5009

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install helpers
        run: |
          set -euo pipefail
          sudo apt-get -qq update
          sudo apt-get -qq install -y --no-install-recommends \
          curl ca-certificates wget tar xz-utils gzip gettext-base \
          build-essential file libncurses-dev zlib1g-dev gawk git \
          gettext libssl-dev xsltproc rsync wget unzip python3 python3-distutils
      - name: Load device env + set download base
        run: |
          set -euo pipefail
          source devices/${{ matrix.device }}/env.sh

          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "PROFILE=$PROFILE" >> $GITHUB_ENV
          echo "OPKG_ARCH=$OPKG_ARCH" >> $GITHUB_ENV

          if [ "${OPENWRT_CHANNEL:-release}" = "snapshot" ]; then
            echo "OPENWRT_VERSION=SNAPSHOT" >> $GITHUB_ENV
            echo "DL_BASE=https://downloads.openwrt.org/snapshots" >> $GITHUB_ENV
          else
            V="${OPENWRT_VERSION#v}"
            MAJOR="$(echo "$V" | grep -oE '^[0-9]+\.[0-9]+')"
            echo "OPENWRT_VERSION=$V" >> $GITHUB_ENV
            echo "OPENWRT_VERSION_MAJOR=$MAJOR" >> "$GITHUB_ENV"
            echo "DL_BASE=https://downloads.openwrt.org/releases/$V" >> $GITHUB_ENV
          fi

      - name: Read packages.txt
        run: |
          set -euo pipefail
          PACKAGES="$(grep -hvE '^\s*$|^\s*#' devices/${{ matrix.device }}/packages.txt \
            | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g')"
          echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

      - name: Download ImageBuilder
        run: |
          set -euo pipefail

          # zstd is required for .tar.zst
          sudo apt-get -qq update
          sudo apt-get -qq install -y --no-install-recommends wget tar zstd ca-certificates

          IB_URL="${DL_BASE}/targets/${TARGET}/${SUBTARGET}/openwrt-imagebuilder-${OPENWRT_VERSION}-${TARGET}-${SUBTARGET}.Linux-x86_64.tar.zst"
          echo "IB_URL=$IB_URL"

          wget "$IB_URL" -O imagebuilder.tar.zst

          # Extract .tar.zst
          tar --zstd -xf imagebuilder.tar.zst

          # Normalize directory name
          mv openwrt-imagebuilder-* imagebuilder
          ls ./
          ls imagebuilder/

      - name: Prepare FILES overlay (feeds.tpl + keys.conf + device files)
        run: |
          set -euo pipefail
          # Expand feeds template from device dir
          FEEDS_TPL="devices/${{ matrix.device }}/feeds.conf.tpl"
          if [ ! -f "$FEEDS_TPL" ]; then
            echo "Missing $FEEDS_TPL" >&2
            exit 1
          fi

          # Expand only these vars
          export OPENWRT_VERSION="${{ env.OPENWRT_VERSION }}"
          export OPENWRT_VERSION_MAJOR="${{ env.OPENWRT_VERSION_MAJOR }}"
          export OPKG_ARCH="${{ env.OPKG_ARCH }}"
          envsubst '${OPENWRT_VERSION_MAJOR} ${OPKG_ARCH}' < "$FEEDS_TPL" > imagebuilder/customfeeds.conf

          echo "=== customfeeds.conf ==="
          cat imagebuilder/customfeeds.conf
          sed -i '1r imagebuilder/customfeeds.conf' imagebuilder/repositories.conf
          sed -i '/option check_signature/d' imagebuilder/repositories.conf
          # Download keys listed in keys.conf (KEYID URL)
          KEYCONF="devices/${{ matrix.device }}/keys.conf"
          if [ -f "$KEYCONF" ]; then
            while read -r keyid url; do
              [ -z "${keyid:-}" ] && continue
              case "$keyid" in \#*) continue ;; esac
              echo "Key $keyid <- $url"
              curl -fsSL "$url" -o "imagebuilder/keys/$keyid"
              test -s "imagebuilder/keys/$keyid"
            done < "$KEYCONF"
          else
            echo "No keys.conf for ${{ matrix.device }} (skipping key download)"
          fi

          # Copy device overlay files (optional)
          if [ -d "devices/${{ matrix.device }}/files" ]; then
            cp -a "devices/${{ matrix.device }}/files/." "imagebuilder/files/"
          fi

      - name: Download custom IPKs (optional)
        run: |
          set -euo pipefail
          IPK_LIST="devices/${{ matrix.device }}/ipk-urls.txt"
          if [ -f "$IPK_LIST" ]; then
            while read -r url; do
              [ -z "${url:-}" ] && continue
              case "$url" in \#*) continue ;; esac
              echo "Downloading IPK: $url"
              curl -fL --retry 3 --retry-delay 2 \
                -o "imagebuilder/packages/$(basename "$url")" "$url"
            done < "$IPK_LIST"

          else
            echo "No ipk-urls.txt for ${{ matrix.device }} (skipping custom IPKs)"
          fi

      - name: Build firmware
        run: |
          set -euo pipefail
          cd imagebuilder
          make image PROFILE="${PROFILE}" PACKAGES="${PACKAGES}" FILES="files"

      - name: Collect firmware
        run: |
          set -euo pipefail
          mkdir -p output/${{ matrix.device }}
          cp -a imagebuilder/bin/targets/*/* output/${{ matrix.device }}/
          rm -rf output/${{ matrix.device }}/packages || true

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ matrix.device }}-${{ env.OPENWRT_VERSION }}
          path: output/${{ matrix.device }}
