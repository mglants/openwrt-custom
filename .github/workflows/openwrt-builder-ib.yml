name: OpenWrt Firmware (ImageBuilder )

on:
  workflow_dispatch:
  # push:
  #   paths:
  #     - "devices/**"
  #     - ".github/workflows/firmware-imagebuilder.yml"

env:
  TZ: Europe/Moscow

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        device:
          - ax6s
          # - ax3000t
          # - ax6000
          # - bpi3mini
          # - bpi4
          # - netisn6
          # - rb5009

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build helpers
        run: |
          set -euo pipefail
          sudo apt-get -qq update
          # usign: fingerprint the pubkey
          # opkg-utils: opkg-make-index for local feed
          sudo apt-get -qq install -y --no-install-recommends \
            curl ca-certificates wget tar xz-utils usign opkg-utils

      - name: Load device environment
        run: |
          set -euo pipefail
          source devices/${{ matrix.device }}/env.sh

          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "PROFILE=$PROFILE" >> $GITHUB_ENV

          # normalize version
          if [ "${OPENWRT_CHANNEL:-release}" = "snapshot" ]; then
            echo "OPENWRT_VERSION=SNAPSHOT" >> $GITHUB_ENV
            echo "DL_BASE=https://downloads.openwrt.org/snapshots" >> $GITHUB_ENV
          else
            V="${OPENWRT_VERSION#v}"
            echo "OPENWRT_VERSION=$V" >> $GITHUB_ENV
            echo "DL_BASE=https://downloads.openwrt.org/releases/$V" >> $GITHUB_ENV
          fi

      - name: Read package list
        run: |
          set -euo pipefail
          PACKAGES="$(grep -hvE '^\s*$|^\s*#' devices/${{ matrix.device }}/packages.txt \
            | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g')"
          echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

      - name: Download ImageBuilder
        run: |
          set -euo pipefail
          IB_URL="${DL_BASE}/targets/${TARGET}/${SUBTARGET}/openwrt-imagebuilder-${TARGET}-${SUBTARGET}.Linux-x86_64.tar.xz"
          echo "IB_URL=$IB_URL"
          wget -q "$IB_URL" -O imagebuilder.tar.xz
          tar -xf imagebuilder.tar.xz
          mv openwrt-imagebuilder-* imagebuilder
      - name: Prepare FILES overlay (feeds + keys + device files)
        run: |
          set -euo pipefail
          source devices/${{ matrix.device }}/env.sh

          # Normalize OPENWRT_VERSION (strip leading v, handle snapshot)
          if [ "${OPENWRT_CHANNEL:-release}" = "snapshot" ]; then
            export OPENWRT_VERSION="SNAPSHOT"
          else
            export OPENWRT_VERSION="${OPENWRT_VERSION#v}"
          fi

          export OPKG_ARCH="${OPKG_ARCH}"

          mkdir -p files/etc/opkg

          # Expand per-device feed template
          FEEDS_TPL="devices/${{ matrix.device }}/feeds.conf.tpl"
          if [ ! -f "$FEEDS_TPL" ]; then
            echo "Missing $FEEDS_TPL" >&2
            exit 1
          fi

          # envsubst is provided by gettext-base
          sudo apt-get -qq update
          sudo apt-get -qq install -y --no-install-recommends gettext-base

          envsubst '${OPENWRT_VERSION} ${OPKG_ARCH}' < "$FEEDS_TPL" > files/etc/opkg/customfeeds.conf

          # (optional) show result for debugging
          echo "=== customfeeds.conf ==="
          cat files/etc/opkg/customfeeds.conf

      - name: Download custom IPKs (URL list) and create local feed
        run: |
          set -euo pipefail
          IPK_LIST="devices/${{ matrix.device }}/ipk-urls.txt"

          # local feed directory inside the ImageBuilder tree
          mkdir -p imagebuilder/localrepo

          if [ -f "$IPK_LIST" ]; then
            while read -r url; do
              [ -z "${url:-}" ] && continue
              case "$url" in \#*) continue ;; esac
              echo "Downloading IPK: $url"
              curl -fL --retry 3 --retry-delay 2 \
                -o "imagebuilder/localrepo/$(basename "$url")" "$url"
            done < "$IPK_LIST"

            # Build Packages + Packages.gz for the local repo
            (cd imagebuilder/localrepo && opkg-make-index . > Packages)
            gzip -9c imagebuilder/localrepo/Packages > imagebuilder/localrepo/Packages.gz
          else
            echo "No ipk-urls.txt for ${{ matrix.device }} (skipping custom IPKs)"
          fi

      - name: Configure ImageBuilder repositories (add localrepo first)
        run: |
          set -euo pipefail
          cd imagebuilder

          # Prepend local file:// repo so packages from IPK URLs are available by name
          # Note: file:// path is inside the ImageBuilder container/runtime (we run locally here)
          # This works because we're running make image in this same workspace.
          if [ -d "./localrepo" ] && [ -f "./localrepo/Packages.gz" ]; then
            echo "src/gz local file://$PWD/localrepo" > repositories.local.conf
            cat repositories.conf >> repositories.local.conf
            mv repositories.local.conf repositories.conf
          fi

      - name: Build firmware (ImageBuilder make image)
        run: |
          set -euo pipefail
          cd imagebuilder
          make image PROFILE="${PROFILE}" PACKAGES="${PACKAGES}" FILES="${GITHUB_WORKSPACE}/files"

      - name: Collect firmware
        run: |
          set -euo pipefail
          mkdir -p output/${{ matrix.device }}
          cp -a imagebuilder/bin/targets/*/* output/${{ matrix.device }}/
          rm -rf output/${{ matrix.device }}/packages || true

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ matrix.device }}-${{ env.OPENWRT_VERSION }}
          path: output/${{ matrix.device }}
