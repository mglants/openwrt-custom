#
# https://github.com/P3TERX/Actions-OpenWrt
#
# File: .github/workflows/openwrt-builder-ib.yml
# Description: Build OpenWrt using Image Builder with custom feeds
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: OpenWrt Builder IB

on:
  repository_dispatch:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - '.github/workflows/openwrt-builder-ib.yml'
  #     - '*/.config'
  #     - '*/diy-part*.sh'
  #     - '*/env.sh'

env:
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Europe/Moscow

jobs:
  build:
    runs-on: arc-runner-set-openwrt-custom
    strategy:
      matrix:
        device: [ax6s, ax3000t, ax6000, bpi3mini, bpi4, netisn6, rb5009]
      fail-fast: false

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install wget tar xz-utils
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Prepare files
      run: |
        chmod +x ${{ matrix.device }}/diy-part1.sh
        $GITHUB_WORKSPACE/${{ matrix.device }}/diy-part1.sh

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        release_version="$(date +"%Y.%m.%d-%H%M")"
        release_device="${{ matrix.device }}"
        echo="release_version=$release_version" >> $GITHUB_OUTPUT
        echo="release_device=$release_device" >> $GITHUB_OUTPUT
        echo "release_tag=$release_device-$release_version" >> $GITHUB_OUTPUT
        touch release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Download Image Builder
      working-directory: /workdir
      run: |
        source $GITHUB_WORKSPACE/${{ matrix.device }}/env.sh
        IB_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/${TARGET}/${SUBTARGET}/openwrt-imagebuilder-${TARGET}-${SUBTARGET}.Linux-x86_64.tar.xz"
        wget -q $IB_URL -O imagebuilder.tar.xz
        tar -xf imagebuilder.tar.xz
        mv openwrt-imagebuilder-* imagebuilder
        ln -sf /workdir/imagebuilder $GITHUB_WORKSPACE/imagebuilder

    - name: Setup feeds and files
      run: |
        cd imagebuilder
        cat > feeds.conf << EOF
        src-git packages https://git.openwrt.org/feed/packages.git
        src-git luci https://git.openwrt.org/project/luci.git
        src-git routing https://git.openwrt.org/feed/routing.git
        src-git telephony https://git.openwrt.org/feed/telephony.git
        src-git video https://git.openwrt.org/feed/video.git
        src-git ruantiblock https://github.com/gSpotx2f/ruantiblock_openwrt.git
        src-git v2raya https://github.com/v2rayA/v2raya-openwrt.git
        src-git awg https://github.com/mglants/awg-openwrt.git
        src-git ssclash https://github.com/zerolabnet/SSClash.git
        EOF
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files .
        [ -e $GITHUB_WORKSPACE/${{ matrix.device }}/files ] && cp -r $GITHUB_WORKSPACE/${{ matrix.device }}/files/* files/ || true

    - name: Build image
      id: compile
      run: |
        cd imagebuilder
        source $GITHUB_WORKSPACE/${{ matrix.device }}/env.sh
        PACKAGES="luci-app-ruantiblock luci-app-v2raya luci-app-awg luci-app-ssclash"
        make image PROFILE="$PROFILE" PACKAGES="$PACKAGES" FILES="files"
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DEVICE_NAME=_${PROFILE}" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Check space usage
      if: (!cancelled())
      run: df -hT

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd imagebuilder/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: Upload firmware to release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 2

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
        delete_tag_pattern: ${{ matrix.device }}.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
