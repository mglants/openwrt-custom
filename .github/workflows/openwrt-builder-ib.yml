name: OpenWrt Firmware (ImageBuilder)

on:
  workflow_dispatch:
  # push:
  #   paths:
  #     - "devices/**"
  #     - ".github/workflows/firmware-imagebuilder.yml"

env:
  TZ: Europe/Moscow

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        device:
          - ax6s
          # - ax3000t
          # - ax6000
          # - bpi3mini
          # - bpi4
          # - netisn6
          # - rb5009

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install helpers
        run: |
          set -euo pipefail
          sudo apt-get -qq update
          sudo apt-get -qq install -y --no-install-recommends \
            curl ca-certificates wget tar xz-utils gzip gettext-base

      - name: Load device env + set download base
        run: |
          set -euo pipefail
          source devices/${{ matrix.device }}/env.sh

          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "PROFILE=$PROFILE" >> $GITHUB_ENV
          echo "OPKG_ARCH=$OPKG_ARCH" >> $GITHUB_ENV

          if [ "${OPENWRT_CHANNEL:-release}" = "snapshot" ]; then
            echo "OPENWRT_VERSION=SNAPSHOT" >> $GITHUB_ENV
            echo "DL_BASE=https://downloads.openwrt.org/snapshots" >> $GITHUB_ENV
          else
            V="${OPENWRT_VERSION#v}"
            echo "OPENWRT_VERSION=$V" >> $GITHUB_ENV
            echo "DL_BASE=https://downloads.openwrt.org/releases/$V" >> $GITHUB_ENV
          fi

      - name: Read packages.txt
        run: |
          set -euo pipefail
          PACKAGES="$(grep -hvE '^\s*$|^\s*#' devices/${{ matrix.device }}/packages.txt \
            | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g')"
          echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

      - name: Download ImageBuilder
        run: |
          set -euo pipefail

          # zstd is required for .tar.zst
          sudo apt-get -qq update
          sudo apt-get -qq install -y --no-install-recommends wget tar zstd ca-certificates

          IB_URL="${DL_BASE}/targets/${TARGET}/${SUBTARGET}/openwrt-imagebuilder-${OPENWRT_VERSION}-${TARGET}-${SUBTARGET}.Linux-x86_64.tar.zst"
          echo "IB_URL=$IB_URL"

          wget "$IB_URL" -O imagebuilder.tar.zst

          # Extract .tar.zst
          tar --zstd -xf imagebuilder.tar.zst

          # Normalize directory name
          mv openwrt-imagebuilder-* imagebuilder


      - name: Prepare FILES overlay (feeds.tpl + keys.conf + device files)
        run: |
          set -euo pipefail
          mkdir -p files/etc/opkg

          # Expand feeds template from device dir
          FEEDS_TPL="devices/${{ matrix.device }}/feeds.conf.tpl"
          if [ ! -f "$FEEDS_TPL" ]; then
            echo "Missing $FEEDS_TPL" >&2
            exit 1
          fi

          # Expand only these vars
          export OPENWRT_VERSION="${{ env.OPENWRT_VERSION }}"
          export OPKG_ARCH="${{ env.OPKG_ARCH }}"
          envsubst '${OPENWRT_VERSION} ${OPKG_ARCH}' < "$FEEDS_TPL" > files/etc/opkg/customfeeds.conf

          echo "=== customfeeds.conf ==="
          cat files/etc/opkg/customfeeds.conf

          # Download keys listed in keys.conf (KEYID URL)
          KEYCONF="devices/${{ matrix.device }}/keys.conf"
          if [ -f "$KEYCONF" ]; then
            mkdir -p files/etc/opkg/keys
            while read -r keyid url; do
              [ -z "${keyid:-}" ] && continue
              case "$keyid" in \#*) continue ;; esac
              echo "Key $keyid <- $url"
              curl -fsSL "$url" -o "files/etc/opkg/keys/$keyid"
              test -s "files/etc/opkg/keys/$keyid"
            done < "$KEYCONF"
          else
            echo "No keys.conf for ${{ matrix.device }} (skipping key download)"
          fi

          # Copy device overlay files (optional)
          if [ -d "devices/${{ matrix.device }}/files" ]; then
            cp -a "devices/${{ matrix.device }}/files/." "files/"
          fi

      - name: Download custom IPKs (optional) and add localrepo feed
        run: |
          set -euo pipefail
          IPK_LIST="devices/${{ matrix.device }}/ipk-urls.txt"
          mkdir -p imagebuilder/localrepo

          if [ -f "$IPK_LIST" ]; then
            while read -r url; do
              [ -z "${url:-}" ] && continue
              case "$url" in \#*) continue ;; esac
              echo "Downloading IPK: $url"
              curl -fL --retry 3 --retry-delay 2 \
                -o "imagebuilder/localrepo/$(basename "$url")" "$url"
            done < "$IPK_LIST"

            # Minimal index so opkg sees files in this repo
            : > imagebuilder/localrepo/Packages
            for ipk in imagebuilder/localrepo/*.ipk; do
              [ -e "$ipk" ] || break
              echo "Filename: $(basename "$ipk")" >> imagebuilder/localrepo/Packages
              echo "" >> imagebuilder/localrepo/Packages
            done
            gzip -9c imagebuilder/localrepo/Packages > imagebuilder/localrepo/Packages.gz

            # Put localrepo FIRST in repositories.conf (build-time)
            cd imagebuilder
            echo "src/gz local file://$PWD/localrepo" > repositories.local.conf
            cat repositories.conf >> repositories.local.conf
            mv repositories.local.conf repositories.conf
            cd ..
          else
            echo "No ipk-urls.txt for ${{ matrix.device }} (skipping custom IPKs)"
          fi

      - name: Build firmware
        run: |
          set -euo pipefail
          cd imagebuilder
          make image PROFILE="${PROFILE}" PACKAGES="${PACKAGES}" FILES="${GITHUB_WORKSPACE}/files"

      - name: Collect firmware
        run: |
          set -euo pipefail
          mkdir -p output/${{ matrix.device }}
          cp -a imagebuilder/bin/targets/*/* output/${{ matrix.device }}/
          rm -rf output/${{ matrix.device }}/packages || true

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ matrix.device }}-${{ env.OPENWRT_VERSION }}
          path: output/${{ matrix.device }}
